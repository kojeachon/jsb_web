{% extends "leases/base2.html" %}
{% load static %}

{% block style %}
<style>
    .input-group-prepend{width: 100px;}
    .d-flex{margin-top: 10px;}
</style>
{% endblock style %}

{% block content %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10">
                <div class="card card-primary">
                    <div class="card-header">
                      <h3 class="card-title">예약 추가</h3>
                    </div>
                    <div class="card-body">
                        <div id="alert-box"></div>
                        <!-- Date -->
                        <form id="leaseForm" name="form1" class="mt-5" action="{% url 'leases:lease_create'%}">
                            {% csrf_token %}
                            <div class="d-flex flex-row">
                                <div class="form-inline">
                                    <label class="input-group-prepend input-group-label">예약일정: </label>
                                    <div class="input-group date ml-3" id="st_text">
                                        <input type="text" name="st_date" id="st_date" value="" class="form-control">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <div class="input-group-addon">
                                                    <i class="far fa-calendar-alt fa-lg"></i>
                                                </div>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="ml-3"><label class="input-group-label"> ~ </label></div>
                                <div class="form-inline">
                                    <!-- <label class="input-group-prepend input-group-label">예약일정(종료): </label> -->
                                    <div class="input-group date ml-3" id="ed_text">
                                        <input type="text" name="ed_date" id="ed_date" value="" class="form-control">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <div class="input-group-addon">
                                                    <i class="far fa-calendar-alt fa-lg"></i>
                                                </div>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <label class="input-group-prepend input-group-label">유형1: </label>
                                    <div class="input-group ml-3 w-50">
                                        <select class="form-control select2" name="type1" id="type1">
                                            <option selected="selected">선택</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">유형2: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <select class="form-control select2" name="type2" id="type2" style="width: 200px;">
                                            <option selected="selected">선택</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">호실: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <select class="form-control select2" name="roomnumber" id="roomnumber" style="width: 200px;">
                                            <option selected="selected">선택</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">인원수: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <input type="text" class="form-control" name="usepeople" id="usepeople" placeholder="인원수" style="width: 200px;">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">금액: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <input type="text" class="form-control" name="roommoney" id="roommoney" placeholder="금액" style="width: 200px;" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">예약자명: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <input type="text" class="form-control" name="leasename" id="leasename" placeholder="예약자명" style="width: 200px;">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">연락처: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <input type="text" class="form-control" name="phonenumber" id="phonenumber" placeholder="연락처" style="width: 200px;">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row">
                                <div class="form-inline w-50">
                                    <div class="input-group-prepend">
                                        <label class="input-group-prepend input-group-label">메모: </label>
                                    </div>
                                    <div class="input-group ml-3 w-50">
                                        <textarea class="form-control" rows="3" name="contents" id="contents" placeholder="메모" style="width: 200px;"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-row"">
                                <div class="form-inline justify-content-md-center w-50">
                                    <button type="submit" class="btn btn-primary w-25">저장</button>
                                </div>
                            </div>

                        </form>

                      <!-- /.form group -->
                    </div>
                    <div class="card-footer">
                        Card Footer
                    </div>
                <!-- /.card-body -->

                </div>
            </div>
        </div>


    </div>
</section>
{% endblock content %}

{% block script %}


<!-- <script src="{% static 'js/leases/main.js' %}" defer></script> -->
<script>
// console.log("Hello world!!")    
    $(function () {

        function dataint(){
            $("#type1").val('선택')
            $("#type2").val('선택')
            $("#roomnumber").val('선택')
        }

        //Start Date picker
        $('#st_text').datetimepicker({
            locale: "ko",
            format: "YYYY-MM-DD",
            defaultDate: moment()
        }).on("dp.change", function (e){
            dataint()
        });

        //End Date picker
        $('#ed_text').datetimepicker({
            locale: "ko",
            format: "YYYY-MM-DD",
            defaultDate: moment()
        }).on("dp.change", function (e){
            dataint()
        });

        function datecheck(st_date,ed_date){
            if(st_date>ed_date){
                return false
            }
            return true
        }

        const type1select = document.getElementById('type1')
        const type2select = document.getElementById('type2')
        const roomnumberselect = document.getElementById('roomnumber')
        const roommoneyinput = document.getElementById('roommoney')
        const alertBox = document.getElementById('alert-box')
        const csrf = document.getElementsByName('csrfmiddlewaretoken')

        $.ajax({
            type: 'GET',
            url: '/leases/type1-json/',
            success: function(response){
                const type1Data = response.data
                // console.log(type1Data)
                type1Data.forEach(element => {
                const type1option = document.createElement('option')
                type1option.text = element.type1
                type1option.setAttribute('value', element.type1)
                type1select.appendChild(type1option)
                // console.log(element.type1)
                });
            },
            error: function(error){
                console.log(error)
            }
        })

        $('.datetimepicker').click(function(e){
            console.log('ttttt')
        })

        type1select.addEventListener('change', e=>{
            // console.log(e.target.value)
            const selectedtype1 = e.target.value

            // alertBox.innerHTML=""
            type2select.innerHTML = ""
            const type2option = document.createElement('option')
            type2option.text = "선택"
            type2option.setAttribute('selected','')
            type2select.appendChild(type2option)

            if(st_date=="" || ed_date==""){
                alertBox.innerHTML = `<div class="ui negative message">
                                        <div class="header">
                                        예약일정 선택
                                        </div>
                                        <p>예약일정을 먼저 선택 하세요.</p>
                                    </div>`
                return
            }
            console.log('st_date=',st_date,ed_date);

            $.ajax({
                type: 'GET',
                url: `/leases/type2-json/${selectedtype1}/`,
                success: function(response){
                    console.log(response.data)
                    const type2Data = response.data
                    type2Data.forEach(element => {
                    const type2option = document.createElement('option')
                    type2option.text = element.type2
                    type2option.setAttribute('value', element.type2)
                    type2select.appendChild(type2option)
                    // console.log(element.type2)
                    });
                },
                error: function(error){
                    console.log(error)
                }
            })
        })

        var dictObject = {}
        type2select.addEventListener('change', e=>{
            // console.log(e.target.value)
            const selectedtype2 = e.target.value
            var st_date = $("#st_date").val()
            var ed_date = $("#ed_date").val()
            var type1 = $("#type1").val()

            // alertBox.innerHTML=""
            roomnumberselect.innerHTML = ""
            const roomnumberoption = document.createElement('option')
            roomnumberoption.text = "선택"
            roomnumberoption.setAttribute('selected','')
            roomnumberselect.appendChild(roomnumberoption)
            roommoneyinput.value = ""

            $.ajax({
                type: 'GET',
                url: `/leases/roomnumber-json/${selectedtype2}/`,
                dataType: 'json',
                data: {
                    type1 : type1,
                    st_date : st_date,
                    ed_date : ed_date,
                },
                success: function(response){
                    console.log(response.data)
                    const roomnumberData = response.data
                    roomnumberData.forEach(element => {
                    const roomnumberoption = document.createElement('option')
                    roomnumberoption.text = element.roomnumber
                    roomnumberoption.setAttribute('value', element.roomnumber)
                    roomnumberselect.appendChild(roomnumberoption)
                    dictObject[element.roomnumber] = element.roommoney
                    // console.log(element.roomnumber,element.roommoney)
                    });

                    // modelInput.addEventListener('change', e=>{
                    //     btnBox.classList.remove('not-visible')
                    // })
                },
                error: function(error){
                    console.log(error)
                }
            })
        })

        roomnumberselect.addEventListener('change', e=>{
            console.log(e.target.value,dictObject[e.target.value])
            roommoneyinput.value = dictObject[e.target.value]
        })
        
        // $("#leaseForm").submit(function(e){
        //   e.preventDefault()
        //   console.log('submitted',$("#st_date").val())
        // })
        leaseForm.addEventListener('submit', e=>{
            e.preventDefault()
            alertBox.innerHTML = ""

            var st_date = $("#st_date").val()
            var ed_date = $("#ed_date").val()
            var roomnumber = $("#roomnumber").val()
            if(!datecheck(st_date,ed_date)){
                console.log('Fail 1....')
                alertBox.innerHTML = `<div class="ui negative message">
                                        <div class="header">
                                        날짜 오류
                                        </div>
                                        <p>시작 날짜가 종료 날짜보다 클 수 없습니다.</p>
                                    </div>`
                return
            }
            if(roomnumber=='선택'){
                console.log('Fail 2....')
                alertBox.innerHTML = `<div class="ui negative message">
                                        <div class="header">
                                        룸 선택
                                        </div>
                                        <p>룸을 선택 해야 합니다.</p>
                                    </div>`
                return
            }


            $.ajax({
            type: 'POST',
            url: '/leases/save-lease-create/',
            data: {
                'csrfmiddlewaretoken': csrf[0].value,
                'st_date':st_date,
                'ed_date':ed_date,
                'type1':$("#type1").val(),
                'type2':$("#type2").val(),
                'roomnumber':roomnumber,
                'usepeople':$("#usepeople").val(),
                'leasename':$("#leasename").val(),
                'phonenumber':$("#phonenumber").val(),
                'contents':$("#contents").val(),
            },
            success: function(response){
                console.log(response)
                alertBox.innerHTML = `<div class="ui positive message">
                                        <div class="header">
                                        Success
                                        </div>
                                        <p>Your order has been placed</p>
                                    </div>`
                $(location).attr('href', '/leases')
            },
            error: function(error){
                console.log(error)
                alertBox.innerHTML = `<div class="ui negative message">
                                        <div class="header">
                                        Error
                                        </div>
                                        <p>Something went wrong</p>
                                    </div>`
            }
            })
        })

        $.validator.setDefaults({
            submitHandler: function () {
                alert( "Form successful submitted!" );
            }
        });
        $('#leaseForm').validate({
            rules: {
                st_date: {
                    required: true,
                },
                ed_date: {
                    required: true,
                },
                type1: {
                    required: true,
                },
                type2: {
                    required: true,
                },
                roomnumber: {
                    required: true,
                },
                roommoney: {
                    required: true,
                },
                usepeople: {
                    required: true,
                },
                leasename: {
                    required: true,
                },
                phonenumber: {
                    required: true
                },
            },
            messages: {
                email: {
                    required: "Please enter a email address",
                    email: "Please enter a vaild email address"
                },
                password: {
                    required: "Please provide a password",
                    minlength: "Your password must be at least 5 characters long"
                },
                terms: "Please accept our terms"
            },
            errorElement: 'span',
            errorPlacement: function (error, element) {
                error.addClass('invalid-feedback');
                element.closest('.form-group').append(error);
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass('is-invalid');
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass('is-invalid');
            }
        });

        // $('#type1').change(function(e){
        //     console.log('ttttt')
        // })



    })

</script>

{% endblock script%}